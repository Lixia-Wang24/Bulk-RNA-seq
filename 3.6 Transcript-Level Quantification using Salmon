This script details the process of building the Salmon index and quantifying transcript abundance from trimmed paired-end FASTQ files.
# Build Salmon index: transcripts.fa
Index="/Users/lixia/Data/database/ref_RNA/Ensembl/salmon_Ensembl_index"
Out_dir="/Users/lixia/Data/data/Fractionation_seq/Salmon/Ensembl"
Threads=8
mkdir -p "${Out_dir}"

sample="K562.LabE.polyA.cyt.rep1 K562.LabE.polyA.cyt.rep2 K562.LabE.polyA.nuc.rep1 K562.LabE.polyA.nuc.rep2"

for s in ${sample}
do

# step: Generate the quant.sf file. This script takes about 7 minutes to run.
salmon quant \
    -i "${Index}" \
    -l A \
    -1 "${s}.1.trimmed.fastq.gz" \
    -2 "${s}.2.trimmed.fastq.gz" \
    -o "${Out_dir}/${s}" \
    -p "$Threads" \
    --rangeFactorizationBins 4 \
    --validateMappings \
    --gcBias \
    --seqBias
# Salmon Parameter Key:
# -i: Path to the Salmon index directory.
# -l A: Auto-detect library type (usually automatically determined for Illumina data).
# -1, -2: Input paired-end FASTQ files.
# -o: Output directory for quantification results.
# -p: Number of threads to use.
# --rangeFactorizationBins 4: Improves accuracy for transcripts with low expression or high variability.
# --validateMappings: Uses read alignments to improve quantification accuracy (recommended).
# --gcBias: Corrects for GC content bias.
# --seqBias: Corrects for sequence specific bias.

# Note: The 'quant.sf' file generated above contains transcript IDs with version numbers, 
# while the Ensembl GTF file might not have them, causing issues in transcript_id 
# to gene_id mapping.
# GENCODE and NCBI annotations typically include version numbers, making this processing unnecessary for them.

# Remove transcript ID version numbers (e.g., ENSG00000000003.15 -> ENSG00000000003)
awk -F'\t' 'BEGIN {OFS="\t"} {
    # Keep the header row unchanged
    if (NR==1) {print}
    else {
        split($1, id, ".");    # Split the transcript_id by the dot
        $1 = id[1];            # Take the first part of the split (the ID without the version)
        print
    }
}' "${Out_dir}/${s}/quant.sf" > "${Out_dir}/${s}/quant.tmp" \
&& mv "${Out_dir}/${s}/quant.tmp" "${Out_dir}/${s}/quant.sf"

Done
